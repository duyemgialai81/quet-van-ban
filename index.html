<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Scanner Pro - FPT Project</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        .container { background: white; width: 100%; max-width: 480px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); box-sizing: border-box; }
        
        h2 { text-align: center; color: #444; margin: 0 0 20px 0; font-size: 20px; }
        
        .camera-box { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Hi·ªáu ·ª©ng qu√©t */
        .scanner-beam { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #00ff00; box-shadow: 0 0 10px #00ff00; display: none; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% {top: 0} 100% {top: 100%} }

        /* Input & Controls */
        .control-group { margin-bottom: 15px; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; margin-bottom: 8px; }
        
        .btn-scan { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 30px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-scan:active { transform: scale(0.98); background: #1557b0; }
        
        #status { text-align: center; font-size: 13px; color: #666; margin-top: 10px; min-height: 20px; }
        
        /* K·∫øt qu·∫£ */
        #result-area { width: 100%; height: 120px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 10px; padding: 10px; font-size: 14px; overflow-y: auto; margin-bottom: 15px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì∏ Smart Scanner Pro</h2>
    
    <div class="camera-box">
        <video id="video" autoplay playsinline muted></video>
        <div id="scan-beam" class="scanner-beam"></div>
    </div>

    <div class="control-group">
        <input type="text" id="webhookUrl" class="input-box" 
               value="https://script.google.com/macros/s/11O-2z4TVPwGByJO-wFonIBOAdjY3MAkTMadbj89Qq-RGd_Lkw3zXa-64/exec" 
               readonly style="background: #e9ecef; color: #666;">
        
        <select id="filterMode" class="input-box">
            <option value="all">üìù L·∫•y to√†n b·ªô vƒÉn b·∫£n</option>
            <option value="score">üíØ Ch·ªâ l·∫•y ƒëi·ªÉm s·ªë (S·ªë)</option>
        </select>
    </div>

    <div id="result-area">K·∫øt qu·∫£ qu√©t s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

    <button class="btn-scan" onclick="processOCR()">
        <span>üîç</span> B·∫ÆT ƒê·∫¶U QU√âT
    </button>
    
    <div id="status">ƒêang kh·ªüi ƒë·ªông Camera...</div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const statusTxt = document.getElementById('status');
    const resultArea = document.getElementById('result-area');
    const scanBeam = document.getElementById('scan-beam');

    // 1. Kh·ªüi ƒë·ªông Camera (Camera sau)
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            video.srcObject = stream;
            statusTxt.innerText = "S·∫µn s√†ng qu√©t";
        } catch (err) {
            statusTxt.innerHTML = "<span style='color:red'>L·ªói: Kh√¥ng m·ªü ƒë∆∞·ª£c Camera (C·∫ßn HTTPS)</span>";
        }
    }

    // 2. H√†m G·ª≠i D·ªØ Li·ªáu (Quan tr·ªçng nh·∫•t)
    async function sendDataToSheet(text) {
        const url = document.getElementById('webhookUrl').value;
        const filter = document.getElementById('filterMode').value;
        
        statusTxt.innerText = "‚è≥ ƒêang g·ª≠i d·ªØ li·ªáu l√™n Sheet...";
        
        try {
            await fetch(url, {
                method: 'POST',
                mode: 'no-cors', // Ch·∫ø ƒë·ªô b·∫Øt bu·ªôc ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    text: text,
                    device: navigator.userAgent.includes("Android") ? "Android" : "iPhone/PC",
                    filterMode: filter
                })
            });
            
            // V√¨ no-cors kh√¥ng tr·∫£ v·ªÅ k·∫øt qu·∫£ n√™n ta th√¥ng b√°o th√†nh c√¥ng lu√¥n
            statusTxt.innerText = "‚úÖ ƒê√£ l∆∞u v√†o Google Sheet!";
            resultArea.style.border = "2px solid #28a745"; // Vi·ªÅn xanh b√°o hi·ªáu OK
            
        } catch (e) {
            statusTxt.innerText = "‚ùå L·ªói g·ª≠i: " + e.message;
        }
    }

    // 3. X·ª≠ l√Ω OCR
    async function processOCR() {
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        scanBeam.style.display = "block"; // B·∫≠t hi·ªáu ·ª©ng qu√©t
        statusTxt.innerText = "ü§ñ ƒêang ƒë·ªçc ch·ªØ...";
        resultArea.innerText = "ƒêang ph√¢n t√≠ch...";

        // Nh·∫≠n di·ªán Ti·∫øng Vi·ªát ('vie')
        const worker = await Tesseract.createWorker('vie');
        const ret = await worker.recognize(canvas);
        await worker.terminate();

        scanBeam.style.display = "none"; // T·∫Øt hi·ªáu ·ª©ng
        const rawText = ret.data.text.trim();

        if (rawText) {
            resultArea.innerText = rawText;
            // T·ª± ƒë·ªông g·ª≠i sau khi qu√©t ƒë∆∞·ª£c
            sendDataToSheet(rawText);
        } else {
            resultArea.innerText = "Kh√¥ng t√¨m th·∫•y ch·ªØ n√†o!";
            statusTxt.innerText = "H√£y th·ª≠ l·∫°i g·∫ßn h∆°n";
        }
    }

    // Ch·∫°y Camera khi m·ªü web
    startCamera();
</script>

</body>
</html>