<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Lens Style OCR - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --google-blue: #1a73e8;
            --google-red: #ea4335;
            --google-grey: #5f6368;
            --bg-color: #f8f9fa;
        }

        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #202124;
        }

        .container {
            width: 92%;
            max-width: 400px;
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(60,64,67,0.3), 0 4px 8px rgba(60,64,67,0.15);
        }

        header {
            text-align: center;
            margin-bottom: 15px;
        }

        header h1 {
            font-size: 20px;
            font-weight: 500;
            margin: 0;
            color: var(--google-grey);
            letter-spacing: 0.5px;
        }

        .camera-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(to right, transparent, var(--google-blue), transparent);
            box-shadow: 0 0 15px var(--google-blue);
            animation: scan 2.5s infinite ease-in-out;
            display: none;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 5%; }
            50% { top: 90%; }
            100% { top: 5%; }
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 12px;
            border: 1px solid #dadce0;
            border-radius: 12px;
            font-size: 14px;
            box-sizing: border-box;
            transition: all 0.3s;
        }

        .input-field:focus {
            border: 2px solid var(--google-blue);
            outline: none;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #result-box {
            width: 100%;
            height: 100px;
            background: #f1f3f4;
            border-radius: 12px;
            padding: 12px;
            font-size: 14px;
            color: #3c4043;
            overflow-y: auto;
            margin-bottom: 16px;
            border: 1px solid #e8eaed;
            white-space: pre-wrap;
            line-height: 1.5;
            user-select: text;
        }

        #error-box {
            width: 100%;
            min-height: 50px;
            background: #fff3cd;
            border-radius: 12px;
            padding: 12px;
            font-size: 12px;
            color: #856404;
            overflow-y: auto;
            margin-bottom: 16px;
            border: 1px solid #ffeaa7;
            white-space: pre-wrap;
            line-height: 1.4;
            font-family: 'Courier New', monospace;
        }

        .btn-main {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 28px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--google-blue);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
            background-color: #1765cc;
        }

        .btn-secondary {
            background-color: #fff;
            color: #1e8e3e;
            border: 1px solid #dadce0;
        }

        .btn-secondary:disabled {
            background-color: #fafafa;
            color: #bdc1c6;
            border: 1px solid #f1f3f4;
        }

        #status-text {
            text-align: center;
            font-size: 12px;
            color: var(--google-grey);
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Smart Scanner</h1>
    </header>
    
    <div class="camera-wrapper">
        <video id="video" autoplay playsinline muted></video>
        <div id="scan-line" class="scan-line"></div>
    </div>

    <input type="text" id="webhookUrl" class="input-field" placeholder="D√°n link nh·∫≠n d·ªØ li·ªáu t·∫°i ƒë√¢y..." value="https://script.google.com/macros/s/AKfycbxYOUR_SCRIPT_ID_HERE/exec">
    
    <div style="background: #e7f3ff; padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 11px; color: #014361; line-height: 1.4;">
        ‚ÑπÔ∏è Qu√©t xong s·∫Ω t·ª± ƒë·ªông g·ª≠i d·ªØ li·ªáu l√™n link
    </div>
    
    <select id="filterMode" class="input-field">
        <option value="all">L·∫•y t·∫•t c·∫£ vƒÉn b·∫£n</option>
        <option value="score">Ch·ªâ l·∫•y c·ªôt ƒëi·ªÉm (s·ªë)</option>
        <option value="subject_score">L·∫•y t√™n m√¥n + ƒëi·ªÉm</option>
    </select>
    
    <div id="result-box">VƒÉn b·∫£n qu√©t ƒë∆∞·ª£c s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
    
    <div id="error-box">Kh√¥ng c√≥ l·ªói</div>

    <button class="btn-main btn-primary" onclick="startOCR()">
        <span>üîç</span> QU√âT & G·ª¨I T·ª∞ ƒê·ªòNG
    </button>
    
    <div id="status-text">ƒêang kh·ªüi t·∫°o camera sau...</div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const scanLine = document.getElementById('scan-line');
    const resultBox = document.getElementById('result-box');
    const errorBox = document.getElementById('error-box');
    const statusText = document.getElementById('status-text');
    const sendBtn = document.getElementById('sendBtn');

    function logError(msg) {
        errorBox.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        errorBox.style.background = '#ffe0e0';
        errorBox.style.borderColor = '#ff6b6b';
        errorBox.style.color = '#c92a2a';
    }

    function logSuccess(msg) {
        errorBox.innerText = `[${new Date().toLocaleTimeString()}] ‚úÖ ${msg}`;
        errorBox.style.background = '#d4edda';
        errorBox.style.borderColor = '#28a745';
        errorBox.style.color = '#155724';
    }

    // H√†m t·ª± ƒë·ªông g·ª≠i d·ªØ li·ªáu
    async function autoPushData(textContent, filterMode) {
        const url = document.getElementById('webhookUrl').value;

        if (!url || url.includes('YOUR_SCRIPT_ID')) {
            logError("Ch∆∞a c·∫•u h√¨nh link webhook! Vui l√≤ng ƒëi·ªÅn link v√†o √¥ input.");
            alert("‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh link!\n\nVui l√≤ng d√°n link Apps Script v√†o √¥ ƒë·∫ßu ti√™n.");
            return;
        }

        if (url.includes('onedrive') || url.includes('1drv.ms')) {
            alert("‚ö†Ô∏è LINK ONEDRIVE KH√îNG D√ôNG ƒê∆Ø·ª¢C!\n\nH√£y d√πng Google Apps Script.");
            logError("Link OneDrive kh√¥ng h·ªó tr·ª£!");
            return;
        }

        statusText.innerText = "ƒêang g·ª≠i d·ªØ li·ªáu...";
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: textContent, 
                    device: "Mobile Scanner",
                    filterMode: filterMode,
                    timestamp: new Date().toISOString() 
                })
            });
            
            if (response.ok) {
                const result = await response.text();
                statusText.innerText = "‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng!";
                logSuccess(`G·ª≠i OK! ƒê√£ l∆∞u v√†o Google Sheet.`);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (e) {
            logError(`L·ªói g·ª≠i: ${e.message}. Th·ª≠ no-cors...`);
            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ 
                        text: textContent, 
                        device: "Mobile Scanner",
                        filterMode: filterMode,
                        timestamp: new Date().toISOString() 
                    })
                });
                statusText.innerText = "‚úÖ ƒê√£ g·ª≠i (no-cors)";
                logSuccess("ƒê√£ g·ª≠i! Ki·ªÉm tra Google Sheet.");
            } catch (e2) {
                statusText.innerText = "‚ùå G·ª≠i th·∫•t b·∫°i!";
                logError(`L·ªói: ${e2.message}`);
            }
        }
    }

    function showSampleCode() {
        const code = `function doPost(e) {
  try {
    // M·ªü Google Sheet (thay YOUR_SHEET_ID)
    var sheet = SpreadsheetApp.openById("YOUR_SHEET_ID").getActiveSheet();
    
    // Parse d·ªØ li·ªáu t·ª´ OCR Scanner
    var data = JSON.parse(e.postData.contents);
    
    // Th√™m v√†o Sheet: Th·ªùi gian | VƒÉn b·∫£n | Thi·∫øt b·ªã
    sheet.appendRow([
      data.timestamp, 
      data.text, 
      data.device
    ]);
    
    return ContentService.createTextOutput("‚úÖ ƒê√£ l∆∞u!");
  } catch (err) {
    return ContentService.createTextOutput("‚ùå L·ªói: " + err);
  }
}`;
        alert("üìã CODE M·∫™U GOOGLE APPS SCRIPT:\n\n" + code + "\n\nüìå Nh·ªõ thay YOUR_SHEET_ID b·∫±ng ID Sheet c·ªßa b·∫°n!");
        
        // Copy v√†o clipboard n·∫øu c√≥ th·ªÉ
        if (navigator.clipboard) {
            navigator.clipboard.writeText(code);
            logSuccess("ƒê√£ copy code v√†o clipboard!");
        }
    }

    async function initCamera() {
        const constraints = {
            audio: false,
            video: {
                facingMode: { ideal: "environment" },
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play();
                statusText.innerText = "Camera sau ƒë√£ s·∫µn s√†ng";
            };
        } catch (err) {
            console.error("Camera Error: ", err);
            statusText.innerHTML = "<span style='color:red'>L·ªói: Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c Camera sau. H√£y d√πng HTTPS!</span>";
            logError(`Camera Error: ${err.message}`);
        }
    }

    async function startOCR() {
        if (!video.srcObject) {
            logError("Camera ch∆∞a s·∫µn s√†ng!");
            return alert("Camera ch∆∞a s·∫µn s√†ng!");
        }

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // TƒÉng ƒë·ªô ph√¢n gi·∫£i ƒë·ªÉ OCR ch√≠nh x√°c h∆°n
        canvas.width = video.videoWidth * 2;
        canvas.height = video.videoHeight * 2;
        
        // V·∫Ω ·∫£nh v·ªõi scale l·ªõn h∆°n
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // TI·ªÄN X·ª¨ L√ù ·∫¢NH - TƒÉng ƒë·ªô t∆∞∆°ng ph·∫£n
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        // Chuy·ªÉn sang grayscale v√† tƒÉng ƒë·ªô t∆∞∆°ng ph·∫£n
        for (let i = 0; i < data.length; i += 4) {
            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            // TƒÉng t∆∞∆°ng ph·∫£n (threshold)
            const enhanced = gray > 128 ? 255 : 0;
            data[i] = data[i + 1] = data[i + 2] = enhanced;
        }
        ctx.putImageData(imageData, 0, 0);

        scanLine.style.display = "block";
        statusText.innerText = "ƒêang nh·∫≠n di·ªán ch·ªØ vi·∫øt...";
        resultBox.innerText = "ƒêang ph√¢n t√≠ch...";
        logSuccess("B·∫Øt ƒë·∫ßu qu√©t...");
        
        try {
            const worker = await Tesseract.createWorker('vie+eng', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        statusText.innerText = `ƒêang x·ª≠ l√Ω: ${Math.round(m.progress * 100)}%`;
                    }
                }
            });
            
            // C·∫•u h√¨nh Tesseract cho ti·∫øng Vi·ªát t·ªët h∆°n
            await worker.setParameters({
                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz√Ä√Å√Ç√É√à√â√ä√å√ç√í√ì√î√ï√ô√öƒÇƒêƒ®≈®∆†√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆ØƒÇ·∫†·∫¢·∫§·∫¶·∫®·∫™·∫¨·∫Æ·∫∞·∫≤·∫¥·∫∂·∫∏·∫∫·∫º·ªÄ·ªÄ·ªÇ∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·ªÅ·ªÅ·ªÉ·ªÑ·ªÜ·ªà·ªä·ªå·ªé·ªê·ªí·ªî·ªñ·ªò·ªö·ªú·ªû·ª†·ª¢·ª§·ª¶·ª®·ª™·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª¨·ªÆ·ª∞·ª≤·ª¥√ù·ª∂·ª∏·ª≠·ªØ·ª±·ª≥·ªµ√Ω·ª∑·ªπ0123456789.,;:!?()/-+= ',
                tessedit_pageseg_mode: '6', // Assume uniform block of text
            });
            
            const ret = await worker.recognize(canvas);
            await worker.terminate();

            let text = ret.data.text.trim();
            const filterMode = document.getElementById('filterMode').value;
            
            // L·ªçc d·ªØ li·ªáu theo ch·∫ø ƒë·ªô
            if (filterMode === 'score') {
                const scores = text.match(/\d+(\.\d+)?/g);
                text = scores ? scores.join('\n') : "Kh√¥ng t√¨m th·∫•y ƒëi·ªÉm";
                logSuccess(`T√¨m th·∫•y ${scores ? scores.length : 0} ƒëi·ªÉm`);
            } else if (filterMode === 'subject_score') {
                const lines = text.split('\n');
                const filtered = lines.filter(line => /\d/.test(line));
                text = filtered.join('\n');
                logSuccess(`L·ªçc ƒë∆∞·ª£c ${filtered.length} d√≤ng c√≥ ƒëi·ªÉm`);
            } else {
                logSuccess("L·∫•y to√†n b·ªô vƒÉn b·∫£n");
            }
            
            if (text) {
                resultBox.innerText = text;
                statusText.innerText = "Qu√©t th√†nh c√¥ng! ƒêang g·ª≠i...";
                await autoPushData(text, filterMode);
            } else {
                resultBox.innerText = "Kh√¥ng t√¨m th·∫•y vƒÉn b·∫£n n√†o. H√£y th·ª≠ l·∫°i!";
                statusText.innerText = "Qu√©t th·∫•t b·∫°i";
                logError("Kh√¥ng c√≥ d·ªØ li·ªáu sau khi l·ªçc");
            }
        } catch (e) {
            statusText.innerText = "L·ªói x·ª≠ l√Ω OCR!";
            logError(`OCR Error: ${e.message}`);
            console.error(e);
        } finally {
            scanLine.style.display = "none";
        }
    }

    // H√†m t·ª± ƒë·ªông g·ª≠i d·ªØ li·ªáu
    async function autoPushData(textContent, filterMode) {
        const url = document.getElementById('webhookUrl').value;

        if (!url || url.includes('YOUR_SCRIPT_ID')) {
            logError("Ch∆∞a c·∫•u h√¨nh link webhook!");
            alert("‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh link!\n\nVui l√≤ng d√°n link Apps Script v√†o √¥ ƒë·∫ßu ti√™n.");
            return;
        }

        if (url.includes('onedrive') || url.includes('1drv.ms')) {
            alert("‚ö†Ô∏è LINK ONEDRIVE KH√îNG D√ôNG ƒê∆Ø·ª¢C!\n\nH√£y d√πng Google Apps Script.");
            logError("Link OneDrive kh√¥ng h·ªó tr·ª£!");
            return;
        }

        statusText.innerText = "ƒêang g·ª≠i d·ªØ li·ªáu...";
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: textContent, 
                    device: "Mobile Scanner",
                    filterMode: filterMode,
                    timestamp: new Date().toISOString() 
                })
            });
            
            if (response.ok) {
                const result = await response.text();
                statusText.innerText = "‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng!";
                logSuccess(`G·ª≠i OK! ƒê√£ l∆∞u v√†o Google Sheet.`);
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (e) {
            logError(`L·ªói g·ª≠i: ${e.message}. Th·ª≠ no-cors...`);
            try {
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ 
                        text: textContent, 
                        device: "Mobile Scanner",
                        filterMode: filterMode,
                        timestamp: new Date().toISOString() 
                    })
                });
                statusText.innerText = "‚úÖ ƒê√£ g·ª≠i (no-cors)";
                logSuccess("ƒê√£ g·ª≠i! Ki·ªÉm tra Google Sheet.");
            } catch (e2) {
                statusText.innerText = "‚ùå G·ª≠i th·∫•t b·∫°i!";
                logError(`L·ªói: ${e2.message}`);
            }
        }
    }

    initCamera();
</script>

</body>
</html>