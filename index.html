<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner Pro V5.0 - Snapshot Mode</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .container { background: white; width: 100%; max-width: 480px; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        /* Khung camera */
        .camera-box { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: cover; }
        /* Canvas d√πng ƒë·ªÉ ƒë√≥ng bƒÉng ·∫£nh */
        #photo-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 5; }

        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        /* N√∫t b·∫•m ch√≠nh */
        .btn-main { width: 100%; padding: 15px; background: #1a73e8; color: white; border: none; border-radius: 30px; font-weight: 700; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(26,115,232,0.3); transition: 0.2s; }
        .btn-main:active { transform: scale(0.96); background: #1557b0; }
        
        #result { min-height: 60px; max-height: 150px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; overflow-y: auto; margin-bottom: 15px; font-family: monospace; font-size: 13px; color: #333; line-height: 1.5; white-space: pre-wrap; }
        #status { text-align: center; font-size: 13px; color: #666; margin-top: 10px; height: 20px;}
        
        /* Hi·ªáu ·ª©ng qu√©t khi ch·ª•p */
        .scan-flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 10; pointer-events: none; }
        @keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin: 0 0 15px 0; color:#444">üì∏ Smart Scanner V5.0</h3>
    
    <div class="camera-box">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="photo-canvas"></canvas> <div id="flash" class="scan-flash"></div>
    </div>

    <div class="input-group">
        <input type="text" id="webhookUrl" placeholder="Link Web App..." 
               value="https://script.google.com/macros/s/11O-2z4TVPwGByJO-wFonIBOAdjY3MAkTMadbj89Qq-RGd_Lkw3zXa-64/exec" readonly style="background:#eee; color:#555">
               
        <select id="filterMode">
            <option value="all">üìù L·∫•y t·∫•t c·∫£ vƒÉn b·∫£n</option>
            <option value="score">üî¢ Ch·ªâ l·∫•y s·ªë (ƒêi·ªÉm)</option>
        </select>
    </div>

    <div id="result">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>

    <button id="btnAction" class="btn-main" onclick="handleMainAction()">
        <span>üì∏</span> CH·ª§P ·∫¢NH
    </button>
    
    <div id="status">ƒêang kh·ªüi ƒë·ªông Camera...</div>
</div>

<canvas id="process-canvas" style="display:none"></canvas>

<script>
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('photo-canvas');
    const status = document.getElementById('status');
    const resultBox = document.getElementById('result');
    const btnAction = document.getElementById('btnAction');
    const flash = document.getElementById('flash');
    
    let isPhotoTaken = false; // Bi·∫øn tr·∫°ng th√°i: ƒê√£ ch·ª•p hay ch∆∞a?

    // 1. Kh·ªüi ƒë·ªông Camera
    async function initCam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 1920}, height: {ideal: 1080} } // ∆Øu ti√™n ƒë·ªô ph√¢n gi·∫£i cao
            });
            video.srcObject = stream;
            status.innerText = "S·∫µn s√†ng ch·ª•p";
        } catch(e) { status.innerHTML = "<b style='color:red'>L·ªói Camera! C·∫ßn HTTPS.</b>"; }
    }

    // 2. X·ª≠ l√Ω n√∫t b·∫•m ch√≠nh (Ch·ª•p ho·∫∑c Ch·ª•p l·∫°i)
    function handleMainAction() {
        if (!isPhotoTaken) {
            takePhoto(); // N·∫øu ch∆∞a ch·ª•p -> Ch·ª•p
        } else {
            resetCamera(); // N·∫øu ch·ª•p r·ªìi -> Quay l·∫°i camera
        }
    }

    // 3. H√†m Ch·ª•p ·∫£nh (ƒê√≥ng bƒÉng m√†n h√¨nh)
    async function takePhoto() {
        // Hi·ªáu ·ª©ng nh√°y flash
        flash.style.animation = 'none';
        flash.offsetHeight; /* trigger reflow */
        flash.style.animation = 'flashAnim 0.5s forwards';

        // ƒê√≥ng bƒÉng h√¨nh ·∫£nh t·ª´ video sang canvas
        photoCanvas.width = video.videoWidth;
        photoCanvas.height = video.videoHeight;
        photoCanvas.getContext('2d').drawImage(video, 0, 0);
        
        // D·ª´ng video v√† hi·ªán ·∫£nh tƒ©nh
        video.pause();
        photoCanvas.style.display = 'block';
        isPhotoTaken = true;

        // ƒê·ªïi n√∫t th√†nh Ch·ª•p l·∫°i
        btnAction.innerHTML = "<span>üîÑ</span> CH·ª§P L·∫†I";
        btnAction.style.background = "#5f6368"; // ƒê·ªïi m√†u n√∫t cho kh√°c bi·ªát
        
        status.innerText = "‚è≥ ƒêang x·ª≠ l√Ω ·∫£nh...";
        resultBox.innerText = "ƒêang ƒë·ªçc ch·ªØ t·ª´ ·∫£nh tƒ©nh...";

        // B·∫Øt ƒë·∫ßu x·ª≠ l√Ω OCR tr√™n ·∫£nh tƒ©nh
        processStaticImage();
    }

    // 4. H√†m quay l·∫°i Camera (Ch·ª•p l·∫°i)
    function resetCamera() {
        video.play(); // Ch·∫°y l·∫°i video
        photoCanvas.style.display = 'none'; // ·∫®n ·∫£nh tƒ©nh
        isPhotoTaken = false;
        
        // ƒê·ªïi l·∫°i n√∫t Ch·ª•p
        btnAction.innerHTML = "<span>üì∏</span> CH·ª§P ·∫¢NH";
        btnAction.style.background = "#1a73e8";
        
        resultBox.innerText = "K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...";
        status.innerText = "S·∫µn s√†ng ch·ª•p";
        resultBox.style.borderColor = "#e9ecef";
    }

    // 5. X·ª≠ l√Ω OCR (Gi·ªëng b·∫£n c≈© nh∆∞ng ch·∫°y 1 l·∫ßn)
    async function processStaticImage() {
        const processCanvas = document.getElementById('process-canvas');
        processCanvas.width = photoCanvas.width;
        processCanvas.height = photoCanvas.height;
        const ctx = processCanvas.getContext('2d');
        ctx.drawImage(photoCanvas, 0, 0);

        // TƒÉng t∆∞∆°ng ph·∫£n (Pre-process)
        const imgData = ctx.getImageData(0,0, processCanvas.width, processCanvas.height);
        const d = imgData.data;
        for(let i=0; i<d.length; i+=4) {
            const c = (d[i]+d[i+1]+d[i+2])/3 > 110 ? 255 : 0;
            d[i]=d[i+1]=d[i+2]=c;
        }
        ctx.putImageData(imgData,0,0);

        // Ch·∫°y Tesseract
        const worker = await Tesseract.createWorker('vie');
        const ret = await worker.recognize(processCanvas);
        await worker.terminate();

        const text = ret.data.text.trim();
        if(text.length > 2) {
            resultBox.innerText = text;
            sendData(text);
        } else {
            resultBox.innerText = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ch·ªØ. ·∫¢nh c√≥ th·ªÉ b·ªã m·ªù.";
            status.innerText = "‚ö†Ô∏è H√£y th·ª≠ ch·ª•p l·∫°i";
        }
    }

    // 6. G·ª≠i d·ªØ li·ªáu (Fire & Forget)
    function sendData(text) {
        const url = document.getElementById('webhookUrl').value;
        const mode = document.getElementById('filterMode').value;
        status.innerText = "üöÄ ƒêang g·ª≠i l√™n Sheet...";
        
        if(url.length > 10) {
            fetch(url, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'text/plain'},
                body: JSON.stringify({
                    text: text,
                    device: /Android/i.test(navigator.userAgent) ? "Android" : "iPhone",
                    filterMode: mode
                })
            });
        }
        setTimeout(() => {
            status.innerText = "‚úÖ ƒê√£ g·ª≠i xong!";
            resultBox.style.borderColor = "green";
        }, 800);
    }
    
    initCam();
</script>
</body>
</html>