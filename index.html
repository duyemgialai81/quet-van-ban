<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Scanner V5.0 (Final)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .container { background: white; width: 100%; max-width: 480px; padding: 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* Khung Camera */
        .camera-box { width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 15px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #photo-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: none; z-index: 5; } /* ·∫¢nh tƒ©nh */

        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        
        /* N√∫t b·∫•m l·ªõn */
        .btn-main { width: 100%; padding: 16px; background: #1a73e8; color: white; border: none; border-radius: 30px; font-weight: 700; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 4px 10px rgba(26,115,232,0.3); transition: 0.2s; }
        .btn-main:active { transform: scale(0.96); background: #1557b0; }
        
        #result { min-height: 80px; max-height: 200px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 12px; overflow-y: auto; margin-bottom: 15px; font-family: monospace; font-size: 13px; color: #333; white-space: pre-wrap; }
        #status { text-align: center; font-size: 13px; color: #666; margin-top: 10px; height: 20px; }

        /* Hi·ªáu ·ª©ng Flash khi ch·ª•p */
        .flash-effect { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 10; }
        @keyframes flashAnim { 0% { opacity: 0.8; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div class="container">
    <h3 style="text-align:center; margin: 0 0 15px 0; color:#444">üì∏ Smart Scanner V5.0</h3>
    
    <div class="camera-box">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="photo-canvas"></canvas> <div id="flash" class="flash-effect"></div>
    </div>

    <div class="input-group">
        <input type="text" id="webhookUrl" placeholder="D√°n link Web App v√†o ƒë√¢y..." value="https://script.google.com/macros/s/11O-2z4TVPwGByJO-wFonIBOAdjY3MAkTMadbj89Qq-RGd_Lkw3zXa-64/exec">
               
        <select id="filterMode">
            <option value="all">üìù L·∫•y t·∫•t c·∫£ vƒÉn b·∫£n</option>
            <option value="score">üî¢ Ch·ªâ l·∫•y s·ªë (ƒêi·ªÉm)</option>
        </select>
    </div>

    <div id="result">H√£y ch·ª•p ·∫£nh ƒë·ªÉ qu√©t...</div>

    <button id="btnAction" class="btn-main" onclick="handleAction()">
        <span>üì∏</span> CH·ª§P ·∫¢NH
    </button>
    
    <div id="status">ƒêang kh·ªüi ƒë·ªông Camera...</div>
</div>

<canvas id="process-canvas" style="display:none"></canvas>

<script>
    const video = document.getElementById('video');
    const photoCanvas = document.getElementById('photo-canvas');
    const status = document.getElementById('status');
    const resultBox = document.getElementById('result');
    const btnAction = document.getElementById('btnAction');
    const flash = document.getElementById('flash');
    
    let isCaptured = false;

    // 1. M·ªü Camera
    async function initCam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: {ideal: 1920} } 
            });
            video.srcObject = stream;
            status.innerText = "S·∫µn s√†ng ch·ª•p";
        } catch(e) { status.innerHTML = "<b style='color:red'>L·ªói Camera!</b>"; }
    }

    // 2. X·ª≠ l√Ω n√∫t b·∫•m (Ch·ª•p / Ch·ª•p l·∫°i)
    function handleAction() {
        if (!isCaptured) {
            capturePhoto();
        } else {
            resetScan();
        }
    }

    // 3. Ch·ª•p ·∫£nh & ƒê√≥ng bƒÉng
    async function capturePhoto() {
        // Hi·ªáu ·ª©ng nh√°y ƒë√®n
        flash.style.animation = 'none';
        flash.offsetHeight; 
        flash.style.animation = 'flashAnim 0.3s forwards';

        // V·∫Ω video l√™n canvas tƒ©nh
        photoCanvas.width = video.videoWidth;
        photoCanvas.height = video.videoHeight;
        photoCanvas.getContext('2d').drawImage(video, 0, 0);
        
        // Hi·ªán ·∫£nh tƒ©nh, ·∫©n video
        video.pause();
        photoCanvas.style.display = 'block';
        isCaptured = true;

        // ƒê·ªïi n√∫t b·∫•m
        btnAction.innerHTML = "<span>üîÑ</span> QU√âT L·∫†I";
        btnAction.style.background = "#5f6368";
        
        status.innerText = "‚è≥ ƒêang ƒë·ªçc ch·ªØ...";
        resultBox.innerText = "ƒêang ph√¢n t√≠ch h√¨nh ·∫£nh...";
        
        // B·∫Øt ƒë·∫ßu OCR
        processOCR();
    }

    // 4. Quay l·∫°i Camera
    function resetScan() {
        video.play();
        photoCanvas.style.display = 'none';
        isCaptured = false;
        btnAction.innerHTML = "<span>üì∏</span> CH·ª§P ·∫¢NH";
        btnAction.style.background = "#1a73e8";
        status.innerText = "S·∫µn s√†ng ch·ª•p";
        resultBox.innerText = "H√£y ch·ª•p ·∫£nh ƒë·ªÉ qu√©t...";
        resultBox.style.borderColor = "#e9ecef";
    }

    // 5. X·ª≠ l√Ω OCR & G·ª≠i
    async function processOCR() {
        const pCanvas = document.getElementById('process-canvas');
        pCanvas.width = photoCanvas.width;
        pCanvas.height = photoCanvas.height;
        const ctx = pCanvas.getContext('2d');
        ctx.drawImage(photoCanvas, 0, 0);

        // X·ª≠ l√Ω ·∫£nh: TƒÉng t∆∞∆°ng ph·∫£n ƒë·ªÉ ch·ªØ r√µ h∆°n
        const imgData = ctx.getImageData(0,0, pCanvas.width, pCanvas.height);
        const d = imgData.data;
        for(let i=0; i<d.length; i+=4) {
            const c = (d[i]+d[i+1]+d[i+2])/3 > 100 ? 255 : 0; // ƒêen tr·∫Øng
            d[i]=d[i+1]=d[i+2]=c;
        }
        ctx.putImageData(imgData,0,0);

        const worker = await Tesseract.createWorker('vie');
        const ret = await worker.recognize(pCanvas);
        await worker.terminate();

        const text = ret.data.text.trim();
        if(text.length > 2) {
            resultBox.innerText = text;
            sendData(text);
        } else {
            resultBox.innerText = "Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c ch·ªØ n√†o. H√£y ch·ª•p l·∫°i g·∫ßn h∆°n!";
            status.innerText = "‚ö†Ô∏è ·∫¢nh m·ªù";
        }
    }

    // 6. G·ª≠i d·ªØ li·ªáu (Si√™u t·ªëc)
    function sendData(text) {
        const url = document.getElementById('webhookUrl').value.trim();
        const mode = document.getElementById('filterMode').value;
        
        if(url.length < 10) {
            alert("‚ö†Ô∏è Ch∆∞a d√°n link Web App!");
            return;
        }

        status.innerText = "üöÄ ƒêang g·ª≠i d·ªØ li·ªáu...";
        
        fetch(url, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'text/plain'},
            body: JSON.stringify({
                text: text,
                device: /Android/i.test(navigator.userAgent) ? "Android" : "iPhone",
                filterMode: mode
            })
        });

        setTimeout(() => {
            status.innerText = "‚úÖ ƒê√£ g·ª≠i xong!";
            resultBox.style.border = "2px solid green";
        }, 800);
    }
    
    initCam();
</script>
</body>
</html>