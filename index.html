<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCR to Word Online</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 15px; background: #f8fafc; color: #1e293b; }
        .card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        h3 { margin-top: 0; color: var(--primary); }
        
        #video-container { position: relative; width: 100%; aspect-ratio: 4/3; background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .scan-overlay { position: absolute; top: 10%; left: 10%; width: 80%; height: 80%; border: 2px dashed rgba(255,255,255,0.5); pointer-events: none; }

        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; font-size: 14px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-scan { background: var(--primary); color: white; }
        .btn-push { background: var(--success); color: white; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }

        #status { font-size: 13px; margin: 10px 0; color: #64748b; min-height: 1.2em; }
        #result { width: 100%; height: 120px; margin-top: 10px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f1f5f9; font-size: 14px; box-sizing: border-box; overflow-y: auto; }
    </style>
</head>
<body>

<div class="card">
    <h3><center>AI SCANNER TO WORD</center></h3>
    
    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="scan-overlay"></div>
    </div>

    <div id="status">Đang khởi động camera...</div>

    <input type="text" id="wordLink" placeholder="Dán link API hoặc Webhook nhận dữ liệu...">
    
    <div class="btn-group">
        <button class="btn-scan" onclick="captureAndScan()">QUÉT CHỮ</button>
        <button class="btn-push" id="pushBtn" onclick="pushToLink()" disabled>ĐẨY LÊN WORD</button>
    </div>

    <div id="result" contenteditable="true">Kết quả quét sẽ hiện ở đây (có thể sửa)...</div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const statusDiv = document.getElementById('status');
    const pushBtn = document.getElementById('pushBtn');
    const wordLinkInput = document.getElementById('wordLink');

    // 1. Khởi tạo Camera (Fix cho điện thoại)
    async function startCamera() {
        const constraints = {
            video: { 
                facingMode: "environment", // Ưu tiên camera sau
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        try {
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            statusDiv.innerText = "Camera sẵn sàng. Hãy căn chỉnh văn bản.";
        } catch (err) {
            statusDiv.innerText = "Lỗi: " + (err.name === 'NotAllowedError' ? "Bạn chưa cho phép Camera" : err.message);
            console.error(err);
        }
    }

    // 2. Quét chữ
    async function captureAndScan() {
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        statusDiv.innerText = "Đang nhận diện chữ (vui lòng đợi)...";
        
        try {
            const result = await Tesseract.recognize(canvas, 'vie+eng');
            const text = result.data.text.trim();
            
            if (text) {
                resultDiv.innerText = text;
                statusDiv.innerText = "Quét thành công!";
                pushBtn.disabled = false;
            } else {
                statusDiv.innerText = "Không tìm thấy chữ. Hãy thử lại.";
            }
        } catch (error) {
            statusDiv.innerText = "Lỗi OCR: " + error.message;
        }
    }

    // 3. Đẩy dữ liệu lên Link (API/Webhook)
    async function pushToLink() {
        const link = wordLinkInput.value;
        const content = resultDiv.innerText;

        if (!link) {
            alert("Vui lòng dán link nhận dữ liệu!");
            return;
        }

        statusDiv.innerText = "Đang gửi dữ liệu...";
        
        try {
            // Lưu ý: Đây là gửi yêu cầu POST đến một API. 
            // Bạn không thể POST trực tiếp vào một link https://word.office.com/... 
            // mà cần thông qua một trung gian (như Google Script, Zapier, hoặc Backend của bạn)
            const response = await fetch(link, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: content, timestamp: new Date() })
            });

            if (response.ok) {
                statusDiv.innerText = "Đã đẩy dữ liệu lên thành công!";
                alert("Đã gửi thành công!");
            } else {
                statusDiv.innerText = "Lỗi gửi: " + response.statusText;
            }
        } catch (error) {
            statusDiv.innerText = "Lỗi kết nối: Có thể do chính sách CORS";
            console.error(error);
            // Fallback: Copy vào clipboard nếu lỗi link
            navigator.clipboard.writeText(content);
            alert("Lỗi gửi link. Đã tự động Copy nội dung vào bộ nhớ tạm để bạn dán thủ công.");
        }
    }

    window.onload = startCamera;
</script>

</body>
</html>
