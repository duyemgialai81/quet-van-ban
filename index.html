<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera to Word OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; padding: 20px; }
        .container { max-width: 600px; width: 100%; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        video, canvas { width: 100%; border-radius: 8px; background: #000; margin-bottom: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-scan { background: #007bff; color: white; }
        .btn-download { background: #28a745; color: white; display: none; }
        #status { color: #666; font-style: italic; margin-bottom: 10px; }
        #result { width: 100%; height: 150px; border: 1px solid #ddd; padding: 10px; border-radius: 6px; white-space: pre-wrap; overflow-y: auto; background: #fafafa; }
    </style>
</head>
<body>

<div class="container">
    <h2>Quét Camera sang Word</h2>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    
    <div id="status">Đang chờ camera...</div>

    <div class="controls">
        <button class="btn-scan" onclick="captureAndScan()">Chụp & Quét Chữ</button>
        <button id="downloadBtn" class="btn-download" onclick="exportToWord()">Tải file Word (.docx)</button>
    </div>

    <h4>Kết quả nhận diện:</h4>
    <div id="result">Văn bản sẽ hiển thị ở đây...</div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const statusDiv = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');

    // 1. Khởi tạo Camera
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } // Ưu tiên camera sau trên điện thoại
            });
            video.srcObject = stream;
            statusDiv.innerText = "Camera sẵn sàng!";
        } catch (err) {
            statusDiv.innerText = "Lỗi truy cập Camera: " + err.message;
        }
    }

    // 2. Chụp ảnh và dùng Tesseract quét chữ
    async function captureAndScan() {
        // Vẽ khung hình hiện tại lên canvas
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        statusDiv.innerText = "Đang nhận diện chữ (OCR)...";
        resultDiv.innerText = "Đang xử lý...";

        try {
            // Sử dụng Tesseract.js (hỗ trợ Tiếng Việt 'vie' và Tiếng Anh 'eng')
            const result = await Tesseract.recognize(canvas, 'vie+eng', {
                logger: m => {
                    if(m.status === 'recognizing text') {
                        statusDiv.innerText = `Đang quét: ${Math.round(m.progress * 100)}%`;
                    }
                }
            });

            const text = result.data.text.trim();
            if (text) {
                resultDiv.innerText = text;
                statusDiv.innerText = "Quét thành công!";
                downloadBtn.style.display = "inline-block";
            } else {
                resultDiv.innerText = "Không tìm thấy chữ nào trong ảnh.";
                statusDiv.innerText = "Thử lại nhé!";
            }
        } catch (error) {
            statusDiv.innerText = "Lỗi OCR: " + error.message;
        }
    }

    // 3. Xuất nội dung ra file Word
    async function exportToWord() {
        const text = resultDiv.innerText;
        if (!text || text === "Văn bản sẽ hiển thị ở đây...") return;

        const doc = new docx.Document({
            sections: [{
                properties: {},
                children: [
                    new docx.Paragraph({
                        children: [new docx.TextRun(text)],
                    }),
                ],
            }],
        });

        const blob = await docx.Packer.toBlob(doc);
        saveAs(blob, "KetQuaQuet.docx");
    }

    // Chạy camera khi load trang
    initCamera();
</script>

</body>
</html>